Spring Boot 框架为 SQL 数据库提供了广泛的支持，既有用 JdbcTemplate 直接访问 JDBC，同时支持“objectrelational mapping”技术(如 Hibernate，MyBatis)。Spring Data 独立的项目提供对多种关系型和非关系型数据库的访问支持。比如 MySQL, Oracle , MongoDB , Redis, R2DBC，Apache Solr，Elasticsearch...

Spring Boot 也支持嵌入式数据库比如 H2, HSQL, and Derby。这些数据库只需要提供 jar 包就能在内存中维护
数据。我们这章访问关系型数据库。

# DataSource

通常项目中使用 MySQL,Oracle,PostgreSQL 等大型关系数据库。Java 中的 jdbc 技术支持了多种关系型数据库的访问。在代码中访问数据库，我们需要知道数据库程序所在的 ip，端口，访问数据库的用户名和密码以及数据库的类型信息。以上信息用来初始化数据源，数据源也就是 DataSource。数据源表示数据的来源，从某个 ip 上的数据库能够获取数据。javax.sql.DataSource 接口表示数据源，提供了标准的方法获取与数据库绑定的连接对象（Connection）。

java.sql.Connection 是连接对象，在 Connection 上能够从程序代码发送查询命令，更新数据的语句给数据库；同时从 Connection 获取命令的执行结果。Connection 很重要，像一个电话线把应用程序和数据库连接起来。

![image-20240705164036727](https://gitee.com/LowProfile666/image-bed/raw/master/img/202407051640768.png)

DataSource 在 application 配置文件中以 spring.datasource.*作为配置项。类似下面的代码：

```properties
spring.datasource.url=jdbc:mysql://localhost/mydb
spring.datasource.username=dbuser
spring.datasource.password=dbpass
```

以上的配置项来自于自动配置中的DataSourceProperties.java，他是数据源的配置类，更多配置参考这个类的属性。

```java
@ConfigurationProperties(prefix = "spring.datasource")
public class DataSourceProperties implements BeanClassLoaderAware,
InitializingBean {
}
```

查看自动配置类DataSourceAutoConfiguration：

![image-20240705164458589](https://gitee.com/LowProfile666/image-bed/raw/master/img/202407051644624.png)

点进去这个DataSourceProperties类中：

![image-20240705164606774](https://gitee.com/LowProfile666/image-bed/raw/master/img/202407051646820.png)

这个类中有一个驱动器的名字driverClassName，这个属性一般不用我们赋值，Spring Boot 能够从 spring.datasource.url 推断所使用的数据驱动类，如果需要特殊指定请设置spring.datasource.driver-class-name 为驱动类的全限定名称。

在自动配置类DataSourceAutoConfiguration中，有一个@Import注解导入连接池的配置。Spring Boot 支持多种数据库连接池，优先使用 HikariCP，其次是 Tomcat pooling，再次是 Commons DBCP2，如果以上都没有，最后会使用 Oracle UCP 连接池。当项目中 starter 依赖了 spring-boot-starter-jdbc 或者spring-boot-starter-data-jpa 默认添加 HikariCP 连接池依赖，也就是默认使用 HikariCP 连接池。

#  轻量的 JdbcTemplate

使用 JdbcTemplate 给我们提供自定义 SQL, Spring 执行这些 SQL 得到记录结果集。JdbcTemplate 和NamedParameterJdbcTemplate 类是自动配置的，您可以@Autowire 注入到自己的 Bean 中。开箱即用。

JdbcTemplate 执行完整的 SQL 语句，我们将 SQL 语句拼接好，交给 JdbcTemplate 执行，JdbcTemplate 底层就是使用 JDBC 执行 SQL 语句。是 JDBC 的封装类而已。

NamedParameterJdbcTemplate 可以在 SQL 语句部分使用“`:命名参数`”作为占位符, 对参数命名，可读性更好。

NamedParameterJdbcTemplate 包装了 JdbcTemplate 对象，“`:命名参数`”解析后，交给 JdbcTemplate 执行 SQL语句。

JdbcTemplateAutoConfiguration 自动配置了 JdbcTemplate 对象，交给 JdbcTemplateConfiguration 创建了JdbcTemplate 对象。并对 JdbcTemplate 做了简单的初始设置（QueryTimeout，maxRows 等）。

这个自动配置类：

```java
@AutoConfiguration(
    after = {DataSourceAutoConfiguration.class}
)
@ConditionalOnClass({DataSource.class, JdbcTemplate.class})
@ConditionalOnSingleCandidate(DataSource.class)
@EnableConfigurationProperties({JdbcProperties.class})
@Import({DatabaseInitializationDependencyConfigurer.class, JdbcTemplateConfiguration.class, NamedParameterJdbcTemplateConfiguration.class})
public class JdbcTemplateAutoConfiguration {
    public JdbcTemplateAutoConfiguration() {
    }
}
```

这个JdbcProperties是配置模板类的，这个JdbcTemplateConfiguration就是模板类：

![image-20240705165534483](https://gitee.com/LowProfile666/image-bed/raw/master/img/202407051655530.png)

这个JdbcTemplate类就是一个jdbc的封装类。

## 准备环境

可以自己在数据库中创建好表，也可以让SpringBoot创建。SpringBoot 能够自动执行 DDL，DML 脚本。两个脚本文件名称默认是
schema.sql 和 data.sql，脚本文件在类路径中，在启动项目时自动执行。

自动执行脚本还涉及到 spring.sql.init.mode 配置项：

+ always：总是执行数据库初始化脚本
+ never：禁用数据库初始化

> Spring Boot 处理特定的数据库类型，为特定的数据库定制 script 文件。首先设置 spring.sql.init.platform=hsqldb、h2、oracle、mysql、postgresql 等等，其次准备 schema-${platform}. sql 、 data-$​{platform}. sql 脚本文件。

创建项目，加入依赖：Lombok，MySQL Driver, JDBC API

查看一下pom.xml文件：

```xml
<dependencies>
    <!--        JdbcTemplate, 连接池使用：HikariCP-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-jdbc</artifactId>
    </dependency>

    <!--        mysql驱动-->
    <dependency>
        <groupId>com.mysql</groupId>
        <artifactId>mysql-connector-j</artifactId>
        <scope>runtime</scope>
    </dependency>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

当使用Lombok时，右小角可能会有警告 ：

![image-20240705171351013](https://gitee.com/LowProfile666/image-bed/raw/master/img/202407051713049.png)

点击Enable annotation processing解决，或在设置中解决：

![image-20240705171441824](https://gitee.com/LowProfile666/image-bed/raw/master/img/202407051714898.png)

然后先创建一个数据库：blog。

再准备两个脚本，在项目的resources目录下直接创建两个sql文件，schema.sql：

```sql
CREATE TABLE `article` (
	`id` INT ( 11 ) NOT NULL AUTO_INCREMENT COMMENT '主键',
	`user_id` INT ( 11 ) NOT NULL COMMENT '作者 ID',
	`title` VARCHAR ( 100 ) NOT NULL COMMENT '文章标题',
	`summary` VARCHAR ( 200 ) DEFAULT NULL COMMENT '文章概要',
	`read_count` INT ( 11 ) UNSIGNED ZEROFILL NOT NULL COMMENT '阅读读数',
	`create_time` datetime NOT NULL COMMENT '创建时间',
`update_time` datetime NOT NULL COMMENT '最后修改时间',
PRIMARY KEY ( `id` )) ENGINE = INNODB AUTO_INCREMENT = 1 DEFAULT CHARSET = utf8mb4;
```

data.sql：

```sql
INSERT INTO `article`
VALUES ('1', '2101', 'SpringBoot 核心注解', '核心注解的主要作用', '00000008976', '2023-01-16 12:11:12', '2023-01-16 12:11:19');
INSERT INTO `article`
VALUES ('2', '356752', 'JVM 调优', 'HotSpot 虚拟机详解', '00000000026', '2023-01-16 12:15:27', '2023-01-16 12:15:30');
```

IDEA提示没有数据源，点击右边的数据库图标，点击加号，添加一个数据源：

![image-20240705172503364](https://gitee.com/LowProfile666/image-bed/raw/master/img/202407051725430.png)

然后要在sql文件的上面进行选择：

![image-20240705172617234](https://gitee.com/LowProfile666/image-bed/raw/master/img/202407051726279.png)

接下来在application.properties中配置数据库数据源和设置执行数据库脚本：

```properties
spring.datasource.url=jdbc:mysql://localhost:3306/springboot009-blog
spring.datasource.username=root
spring.datasource.password=1234

spring.sql.init.mode=always
```

+ 不需要指定驱动器名字，因为可以从url中推断出来

然后可以启动项目，数据库中应该就会有一张表和两个数据：

![image-20240705173136082](https://gitee.com/LowProfile666/image-bed/raw/master/img/202407051731144.png)

成功之后，就可以将application.properties中的spring.sql.init.mode=always改为never了，否则每次启动项目都会初始化一遍，可能导致数据被覆盖。

## JdbcTemplate 访问 MySQL

项目中依赖了 spring-jdbc 6.0.3，JdbcTemplate 对象会自动创建好。把 JdbcTemplate 对象注入给你的 Bean，再调用 JdbcTemplate 的方法执行查询，更新，删除的 SQL。

JdbcTemplate 上手快，功能非常强大。提供了丰富、实用的方法，归纳起来主要有以下几种类型的方法：
（1）execute 方法：可以用于执行任何 SQL 语句，常用来执行 DDL 语句。
（2）update、batchUpdate 方法：用于执行新增、修改与删除等语句。
（3）query 和 queryForXXX 方法：用于执行查询相关的语句。
（4）call 方法：用于执行数据库存储过程和函数相关的语句。

创建实体类Article：

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Article {
    private Integer id;
    private Integer userId;
    private String title;
    private String summary;
    private Integer readCount;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}
```

进行测试，查询数据库中有多少条数据：

```java
@SpringBootTest
class Springboot009JdbctemplateApplicationTests {
    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Test
    void test01() {
        String sql = "select count(*) from article";
        Long cnt = jdbcTemplate.queryForObject(sql, Long.class);
        System.out.println(cnt);
    }
}
```

输出结果：2

测试占位符 ？：

```java
@Test
void test01() {
    String sql = "select * from article where id= ? ";
    Article cnt = jdbcTemplate.queryForObject(sql, new BeanPropertyRowMapper<>(Article.class), 1);
    System.out.println(cnt);
}
```

+ 使用 BeanPropertyRowMapper 将查询结果集转为实体对象，需要列名与属性名称匹配，像列名为a，属性名也为a，就有个setA方法；像列名为a_b，属性名为aB，就有个setAB方法。
+ 如果有多个占位数，需要多个参数，可以在queryForObject方法的第二个参数后面继续添加

输出结果：

```java
Article(id=1, userId=2101, title=SpringBoot 核心注解, summary=核心注解的主要作用, readCount=8976, createTime=2023-01-16T12:11:12, updateTime=2023-01-16T12:11:19)
```

如果输入一个错误的id，那么queryForObject找不到数据或者找出多个数据就会报错，queryForObject只期望一个数据。