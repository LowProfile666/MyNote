如果要使用自己的 MySQL 数据库，要修改数据库的连接字符串
在 appsettings.json 中修改：

```java
 "Connections": [
    {
      "Key": "default",
        // 修改 value 项
      "Value": "server=localhost;port=3306;database=ZsmTest;uid=root;pwd=2002;",
      "DbContext": "DataContext",
        // 修改 DBType 项
      "DBType": "MySQL" //DataBase, you can choose mysql,sqlserver,pgsql,sqlite,oracle
    }
  ],
```

## Wtm

`Wtm.LoginUserInfo.ITCode` 是用户注册和登录的用户名

`Wtm.LoginUserInfo.Name` 是用户注册时的姓名，登录后显示在 右上角的用户名

`Wtm.LoginUserInfo.Attributes` 是一个 dictionary，其中有以下属性：

```c#
foreach (var item in Wtm.LoginUserInfo.Attributes)
{
    Console.WriteLine(item.Key);
}
Email
Gender
CellPhone
HomePhone
Address
ZipCode
```

该属性的值都是在 "\_Admin" 下的 "用户" 页面里，修改用户的附加信息。

## vm

`vm.Entity` ：是对应模型的实体，里面保存了对应模型的信息

`vm.ControllerName` ：对应 controller 的路径

`vm.LoginUserInfo` ：当前登陆人信息，信息和 `vm.Entity` 里的一样，但是这个不需要手动赋值，`vm.Entity` 需要。

`vm.FC` ：记录对应 controller 传过来的表单数据



## DC

`DC.RunSQL("SQL")` ：执行数据库语句，返回一个 `DataTable` 对象

`DataTable` 中有 `Rows` 属性，可以用 `DataRow` 来访问每一行，`DataRow` 有个 `ItemArray` 属性，是一个数组，是这一行的所有信息；也可以用数组的方式访问，下标从 0 开始，存储的顺序就是数据库的表中的字段顺序。



## 信息查询页面

在 `ZsmTest/Areas/StuQuery/Controllers/_DefaultController.cs` 中会有 StuQuery 下的所有页面的方法，现在有材料上传和信息查询的方法。在信息查询方法中，通过给 vm.Entity 对应属性赋值，可以显示到页面上的对应位置。

```c#
[ActionDescription("_Page.StuQuery..info_query", IsPage = true)]
public ActionResult info_query(string id)
{
    var vm = Wtm.CreateVM<ZsmTest.ViewModel.Data.Stu_SituationVMs.Stu_SituationVM>(id);
    vm.Entity.Idnumber = Wtm.LoginUserInfo.ITCode;
    vm.Entity.Name = Wtm.LoginUserInfo.Name;
    
    DataTable dt = DC.RunSQL("select * from stu_situations where idnumber = " + vm.Entity.Idnumber);
    
    vm.Entity.Subject = dt.Rows[0][5].ToString();
    vm.Entity.Score = Int32.Parse(dt.Rows[0][6].ToString());
    
    return PartialView(vm);
}
```

材料上传页面也是这样，

```C# 
[ActionDescription("_Page.StuQuery..material_upload", IsPage = true)]
public ActionResult material_upload()
{
    var vm = Wtm.CreateVM<ZsmTest.ViewModel.Data.Review_MaterialsVMs.Review_MaterialsVM>();
    vm.Entity.Idnumber = Wtm.LoginUserInfo.ITCode;
    vm.Entity.Name = Wtm.LoginUserInfo.Name;
    DataTable dt = DC.RunSQL("select to_major from stu_infos where idnumber = " + vm.Entity.Idnumber);
    if (dt.DefaultView.Count != 0) //查到数据了
    {
        vm.Entity.To_major = dt.Rows[0][0].ToString();
        return PartialView(vm);
    }
    return Redirect(System.Web.HttpUtility.UrlDecode("./InfoIsNull"));
}
```

材料上传页面将 `wt:display` 改为 `wt:textbox` 这样该区域的数据就会被传输过去，否则不行。为了防止用户修改基础信息，所以在每个区域上设置 `disabled` 属性。

```c#
<wt:form vm="@Model" url="/Data/Review_Materials/Create"  id="g6522975470">
<wt:row  items-per-row="ItemsPerRowEnum.Three">
    <wt:textbox field="Entity.Name" id="g7424113852" disabled/>
    <wt:textbox field="Entity.Idnumber" id="g4078498702" disabled/>
    <wt:textbox field="Entity.To_major" id="g3644124236" disabled />
</wt:row>
```





## 页面样式

`wt:display` 只用来显示数据，不是文本框；`wt:textbox` ：表示文本输入框。



## 导入数据

导入信息，在导入用户界面下载模板，然后在模板中填入信息，可以只填入必填信息（带\*号），其他信息可以不填，但是列必须要保存，不能破坏模板。

导入学生信息，再导入用户信息，用学生的身份证号作为账号登录。



## 定义错误页面

在 `_DefaultController.cs` 中定义一个错误方法：

```c#
[ActionDescription("错误提示")]
public ActionResult InfoIsNull()
{
    var vm = Wtm.CreateVM<BaseVM>();
    return PartialView(vm);
}
```

在 `Areas/StuQuery/Views/_Default` 中创建一个 `InfoIsNull.cshtml` 页面：

```csharp
@using WalkingTec.Mvvm.Core.Extensions;
<div id="g1409657543" style="margin-top:250px;font-size:52px;color:#0015FF;"> 请先填报申请人信息</div>
```

然后在 `_DefaultController.cs` 的 `info_query` 方法中引用它：

```c#
return Redirect(System.Web.HttpUtility.UrlDecode("./InfoIsNull"));
```





